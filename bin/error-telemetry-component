#!/usr/bin/env ruby

require_relative '../init'
require_relative './service'

Service.start

require 'process_host'

dispatcher = ErrorTelemetryComponent::Dispatcher.build
command_subscription = EventStore::Messaging::Subscription.build '$ce-error:command', dispatcher
event_subscription = EventStore::Messaging::Subscription.build '$ce-error', dispatcher

cooperation = ProcessHost::Cooperation.build

cooperation.register command_subscription, 'command-handlers'
cooperation.register event_subscription, 'event-handlers'

# TODO Still need name for this version of start [Scott, Sun Feb 7 2016]
# TODO Would be good to have a shutdown message, but need atomic unit of work [Scott, Sun Feb 7 2016]
cooperation.start!
